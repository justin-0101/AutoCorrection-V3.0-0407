# 作文批改系统详细业务流程

+------------------------------------------------------------------------------------------------------+
|                                   作文批改系统详细业务流程                                             |
+------------------------------------------------------------------------------------------------------+

┌───────────────────────────────────────┐
│            用户提交作文               │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│ │Web界面  │ │文件上传 │ │API提交  │   │
│ └────┬────┘ └────┬────┘ └────┬────┘   │
└──────┼──────────┼──────────┼──────────┘
       │          │          │
       └──────────┼──────────┘
                  ▼
┌───────────────────────────────────────┐    ┌───────────────────────────┐
│            数据验证与预处理           │    │       EssayValidator      │
│                                       │◄───┤ - 检查标题和内容长度      │
│ 1. 检查数据有效性                     │    │ - 过滤非法字符           │
│ 2. 格式标准化                         │    │ - 防XSS攻击处理          │
│ 3. 清理输入数据                       │    └───────────────────────────┘
└───────────────────┬───────────────────┘
                    │
                    ▼
┌───────────────────────────────────────┐    ┌───────────────────────────┐
│            作文记录创建               │    │      EssayService         │
│                                       │◄───┤ - 创建Essay记录           │
│ 1. 创建数据库记录                     │    │ - 设置状态为PENDING       │
│ 2. 设置作文初始状态                   │    │ - 记录元数据              │
│ 3. 分配唯一ID                         │    └───────────────────────────┘
└───────────────────┬───────────────────┘
                    │
                    ▼
┌───────────────────────────────────────┐
│            提交异步任务               │
│                                       │
│ process_essay_correction.delay(id)    │
│                                       │
└───────────────────┬───────────────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │   Celery任务队列    │
         └──────────┬──────────┘
                    │
                    ▼
┌───────────────────────────────────────┐    ┌───────────────────────────┐
│         Celery工作进程初始化          │    │     worker_process_init   │
│                                       │◄───┤ - 创建Flask应用实例       │
│ 1. 创建Flask应用上下文                │    │ - 初始化服务容器          │
│ 2. 初始化服务和连接                   │    │ - 配置数据库连接池        │
│ 3. 注册必要的服务                     │    └───────────────────────────┘
└───────────────────┬───────────────────┘
                    │
                    ▼
┌───────────────────────────────────────┐    ┌───────────────────────────┐
│            任务上下文设置             │    │     setup_task_context    │
│                                       │◄───┤ - 推送应用上下文          │
│ 1. 推送应用上下文                     │    │ - 设置数据库会话          │
│ 2. 准备数据库会话                     │    │ - 初始化任务上下文        │
└───────────────────┬───────────────────┘    └───────────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────┐    ┌───────────────────────────┐
│           批改任务执行                │    │  process_essay_correction │
│                                       │◄───┤ - 更新作文状态            │
│ 1. 获取作文信息                       │    │ - 创建批改记录            │
│ 2. 更新作文状态为CORRECTING           │    │ - 调用AI服务批改          │
│ 3. 创建批改记录                       │    │ - 处理批改结果            │
└───────────────────┬───────────────────┘    └───────────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────┐    ┌───────────────────────────┐
│           调用AI服务批改              │    │      CorrectionService    │
│                                       │◄───┤ - 获取AI客户端            │
│ 1. 获取AI客户端                       │    │ - 执行作文批改            │
│ 2. 调用作文批改API                    │    │ - 解析批改结果            │
│ 3. 接收批改结果                       │    └───────────────────────────┘
└───────────────────┬───────────────────┘
                    │
                    ▼
        ┌────────────────────────┐
        │       是否成功?        │
        └───────┬────────────────┘
                │
        ┌───────┴───────┐
        ▼               ▼
┌───────────────┐  ┌──────────────┐    ┌───────────────────────────┐
│     成功      │  │    失败      │    │        重试机制           │
└───────┬───────┘  └──────┬───────┘    │ - ConnectionError 重试    │
        │                 │        ◄───┤ - TimeoutError 重试       │
        │                 │            │ - 其他错误标记为失败      │
        │                 │            └───────────────────────────┘
        │                 │
        ▼                 ▼
┌───────────────┐  ┌──────────────┐
│更新状态为     │  │更新状态为    │
│COMPLETED      │  │FAILED        │
└───────┬───────┘  └──────┬───────┘
        │                 │
        └────────┬────────┘
                 │
                 ▼
┌───────────────────────────────────────┐    ┌───────────────────────────┐
│            任务上下文清理             │    │    cleanup_task_context   │
│                                       │◄───┤ - 清理数据库会话          │
│ 1. 弹出应用上下文                     │    │ - 弹出应用上下文          │
│ 2. 清理数据库会话                     │    └───────────────────────────┘
└───────────────────┬───────────────────┘
                    │
                    ▼
┌───────────────────────────────────────┐    ┌───────────────────────────┐
│            结果查询与展示             │    │      展示层接口           │
│                                       │◄───┤ - Web界面显示             │
│ 1. 用户查询批改结果                   │    │ - API响应                 │
│ 2. 获取作文和批改记录                 │    │ - PDF报告生成             │
│ 3. 组装并展示结果                     │    └───────────────────────────┘
└───────────────────────────────────────┘