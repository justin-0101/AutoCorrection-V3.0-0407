管理后台闪退问题修复方案
一、问题分析
根据日志和代码审查，我们确定了导致管理后台闪退的两个核心问题：
Essay模型字段问题：
   TypeError: 'grade' is an invalid keyword argument for Essay
AI客户端工厂参数错误：
   获取AI服务失败: AIClientFactory.get_client() missing 1 required positional argument: 'provider_name'

二、修复方案
1. 数据库变更先行
需要在Essay模型中添加grade字段后进行数据库迁移：
Apply
执行数据库迁移:
Apply
2. 参数处理改造
在correction_service.py中采用渐进式参数处理方式，以适应Essay模型可能缺少的字段：
Apply
3. 工厂类强化
在app/core/ai/__init__.py中改进AIClientFactory类：
Apply
4. 配置项依赖处理
检查并更新.env文件，添加必要的配置：
Apply
更新配置文档，说明依赖的环境变量：
Apply
5. 异步任务兼容性处理
确保Celery任务能正确处理grade参数，即使Essay模型中没有该字段：
Apply
三、测试验证方案
测试旧数据兼容性：
Apply
测试参数过滤机制：
Apply
测试AI工厂错误配置处理：
Apply
四、实施步骤
备份现有数据：
Apply
添加Essay模型字段：
修改Essay模型
执行数据库迁移
改进参数处理：
修改CorrectionService.submit_essay方法
验证参数动态过滤功能
增强AI客户端工厂：
修改get_client方法
更新相关调用
配置环境变量：
添加DEFAULT_AI_PROVIDER到.env
更新配置文档
编写并执行测试：
添加单元测试
执行回归测试
重新启动服务：
Apply
验证功能：
测试管理后台访问
测试文件上传
测试批改功能
五、回滚计划
如遇问题，执行以下回滚步骤：
回滚数据库：
Apply
恢复代码版本：
恢复备份的服务实现文件
重启服务：
Apply
以上方案提供了一个全面系统的解决方案，通过数据库变更、动态参数处理、配置增强和完善的测试体系，解决管理后台闪退问题，同时增强了系统的稳健性。