<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小园丁作文批改智能体</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 30px;
            transform: scale(0.85);
            transform-origin: top center;
            height: 117.65%; /* 增加内容高度 */
            width: auto; /* 自动调整宽度 */
            max-width: 100vw; /* 不超过视口宽度 */
            overflow-x: hidden; /* 禁止水平滚动 */
        }
        .container {
            max-width: 1000px; /* 减小最大宽度 */
            margin: 0 auto;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 100%;
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            font-size: 20px;
            text-align: center;
            padding: 15px;
        }
        textarea {
            min-height: 200px;
        }
        #resultSection {
            display: none;
        }
        #loadingSpinner {
            display: none;
        }
        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #198754;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 15px;
        }
        .analysis-section {
            margin-bottom: 20px;
        }
        .analysis-title {
            border-bottom: 2px solid #198754;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        pre {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .main-content {
            margin-bottom: 20px;
            border-radius: 5px;
            padding: 20px;
        }
        .submit-btn {
            background-color: #ff7f50;
            border-color: #ff7f50;
            font-weight: bold;
            padding: 10px 20px;
            margin-top: 20px;
        }
        .submit-btn:hover {
            background-color: #ff6347;
            border-color: #ff6347;
        }
        .result-section {
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .result-link {
            font-size: 18px;
            color: #28a745;
            text-decoration: underline;
        }
        .analysis-block, #originalTextSection {
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            background-color: #fff;
            width: 100%;
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
            box-sizing: border-box;
        }
        .analysis-header {
            background-color: #f8f9fa;
            color: #212529;
            font-weight: bold;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            font-size: 1.1rem;
        }
        .analysis-content {
            padding: 15px;
            border-radius: 0 0 5px 5px;
        }
        .analysis-subtitle {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 10px;
            margin-top: 15px;
            color: #495057;
            border-bottom: 1px dotted #dee2e6;
            padding-bottom: 5px;
        }
        .analysis-content p, .analysis-content li, .analysis-content div {
            font-size: 1.0rem;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        /* 添加打印和PDF生成时的特殊样式 */
        @media print {
            .analysis-block {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin-bottom: 40px !important; /* 打印时增加块间距 */
                border: none !important;
            }
            .detailed-analysis > div {
                page-break-before: always !important; /* 强制每个分析块都在新页开始 */
                margin-top: 20px !important;
            }
            .analysis-header {
                background-color: #f8f9fa !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
                padding: 15px !important;
                margin-bottom: 15px !important;
                border-bottom: 2px solid #333 !important;
            }
            .card {
                border: none !important;
                box-shadow: none !important;
            }
            .card-header {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            /* 确保每段内容不会跨页 */
            p, ul, li, div.mb-4, .analysis-subtitle {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            /* 确保表格不会跨页 */
            table {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
        }
        /* 仅对结果页面应用缩放 */
        body.results-page #resultSection {
            transform: scale(0.9);
            transform-origin: top center;
            margin-bottom: 40px; /* 减少底部间距 */
            width: 111.11%; /* 100/0.9 = 111.11% */
        }
        body.results-page #originalTextSection {
            transform: none;
            transform-origin: unset;
            margin-top: 20px;
            width: 100%;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
        }
        /* 结果页面内容字体大小优化 */
        body.results-page .analysis-content p, 
        body.results-page .analysis-content li, 
        body.results-page .analysis-content div {
            font-size: 1.25rem !important; /* 增大内容字体 */
            line-height: 1.6 !important;
        }
        body.results-page .analysis-subtitle {
            font-size: 1.15rem !important; /* 增大子标题字体 */
            font-weight: 600 !important;
        }
        /* 错别字分析区域样式优化 */
        #spellErrorAnalysis {
            max-height: none; /* 移除最大高度限制 */
            overflow: visible; /* 允许内容完全显示 */
        }
        
        /* 错别字分析项目对齐样式 */
        .error-items-container {
            display: block; /* 改为块级布局 */
            width: 100%;
            margin-bottom: 10px;
        }
        
        .error-card {
            border: 1px solid #f8d7da;
            border-radius: 5px;
            padding: 10px 15px;
            margin-bottom: 15px; /* 增加卡片间距 */
            background-color: #fff5f5;
            width: 100% !important;
            box-sizing: border-box !important;
            display: block !important; /* 确保块级显示 */
            clear: both !important; /* 确保每个卡片另起一行 */
            position: relative !important; /* 添加定位上下文 */
            float: none !important; /* 防止浮动 */
            overflow: visible !important; /* 确保内容不溢出 */
        }
        
        .error-header {
            display: block; /* 改为块级布局 */
            margin-bottom: 8px;
            width: 100%;
        }
        
        .error-text {
            display: inline-block;
            vertical-align: middle;
            font-size: 1.1rem;
        }
        
        .error-number {
            display: inline-block;
            min-width: 24px;
            height: 24px;
            background-color: #dc3545;
            color: white;
            text-align: center;
            line-height: 24px;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .error-content {
            margin-top: 5px;
            margin-left: 34px;
            color: #666;
        }

        .error-wrong {
            color: #dc3545;
            font-weight: bold;
            margin: 0 2px;
        }

        .error-correct {
            color: #28a745;
            font-weight: bold;
            margin: 0 2px;
        }
        
        /* 调整作文原文容器样式 */
        #originalTextSection {
            width: 100% !important;
            margin: 40px auto 20px;
            padding-left: 0;
            padding-right: 0;
            box-sizing: border-box;
        }
        
        /* 确保作文原文卡片与上方错别字区域边距一致 */
        body.results-page #originalTextSection .card-body {
            padding-left: 15px;
            padding-right: 15px;
        }
        
        /* 确保原文区域和上层内容区域使用相同的容器宽度 */
        body.results-page #resultSection .card-body #originalTextSection {
            margin-left: 0;
            margin-right: 0;
            width: 100% !important;
        }
        /* 确保原文文本颜色清晰可见 */
        #originalTextContent {
            color: #212529;
        }
        
        /* 作文原文标题样式 */
        #originalTextSection .analysis-header {
            color: #212529;
        }
        
        /* 作文标题样式 */
        #essayTitle {
            color: #212529;
            text-align: center;
        }
        
        /* 移除之前错误的原文区域样式 */
        #originalTextSection.card {
            margin-top: 20px;
            padding: 0;
            border: none;
        }
        .analysis-block {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        /* 统一原文区域和分析区域的样式 */
        #originalTextSection.analysis-block {
            margin-bottom: 20px;
            margin-top: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        /* 确保原文区域与上方分析模块对齐 */
        body.results-page #resultSection .card-body #originalTextSection.analysis-block {
            width: 100% !important;
            margin-left: auto;
            margin-right: auto;
            padding-left: 0;
            padding-right: 0;
        }

        /* 确保原文区域的内容与分析区域内容对齐 */
        body.results-page #resultSection .card-body #originalTextSection .analysis-content {
            padding-left: 15px;
            padding-right: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4" style="display:none;">作文自动批改系统</h1>
        
        <!-- 添加新的系统名称 -->
        <div class="mb-4" style="text-align: center;">
            <span style="font-size: 30px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); display: inline-block; padding: 8px 15px; background: linear-gradient(to bottom, #f8f9fa, #e9ecef); border-radius: 5px; border: 1px solid #dee2e6; color: #333;">小园丁作文批改智能体</span>
        </div>
        
        <!-- API模式切换 -->
        <div class="card mb-4" style="display:none;">
            <div class="card-body">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="apiModeSwitch" {% if use_mock_api %}checked{% endif %}>
                    <label class="form-check-label" for="apiModeSwitch">
                        使用模拟API (无网络环境下使用)
                    </label>
                </div>
                <small class="text-muted">当前模式: <span id="currentMode">{% if use_mock_api %}模拟API{% else %}真实API{% endif %}</span></small>
            </div>
        </div>
        
        <!-- 按照图片布局重新设计 -->
        <div class="main-content">
            <form id="essayForm">
                <div class="row">
                    <!-- 左侧：输入作文内容 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                输入作文内容
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="subject" class="form-label">作文标题</label>
                                    <input type="text" class="form-control" id="subject" name="subject" placeholder="请输入作文题目">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="article" class="form-label">作文内容</label>
                                    <textarea class="form-control" id="article" name="article" rows="10" placeholder="请输入作文内容"></textarea>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary submit-btn">提交批改</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧：上传作文附件 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                上传作文附件
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="fileUpload" class="form-label">上传作文附件</label>
                                    <input class="form-control" type="file" id="fileUpload" name="file" accept=".docx,.pdf,.jpg,.jpeg,.txt,.doc">
                                    <div class="form-text">支持Word文档(.doc/.docx)、PDF文件(.pdf)、文本文件(.txt)和图片(.jpg/.jpeg)格式</div>
                                    <div class="form-text">系统支持AI智能OCR技术，可直接识别图片中的文字</div>
                                </div>
                                
                                <!-- 显示已选择的文件名 -->
                                <div id="fileDisplay" class="alert alert-primary d-none mb-2">
                                    <small class="file-name"></small>
                                    <button type="button" class="btn-close float-end" aria-label="Close"></button>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary submit-btn">提交批改</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            
            <!-- 加载动画 -->
            <div id="loadingSpinner" class="text-center mt-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在批改中，请耐心等待...</p>
                <p class="text-muted small">批改需要10-30秒，正快马加鞭评分</p>
                <div id="processingStatus" class="mt-2 small text-muted d-none">
                    <div class="alert alert-info">
                        <p class="mb-1"><strong>处理状态：</strong></p>
                        <p id="statusText" class="mb-0">准备处理文件...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 批改完成提示 -->
        <div class="result-section" id="resultComplete">
            <h3 style="font-size: 120%;">已完成批改，请点击查看评分结果</h3>
            <p style="margin-top: 2em;"><a href="#resultSection" class="result-link" id="resultLink" style="font-size: 130%;">查看评分结果</a></p>
        </div>
        
        <!-- 结果展示区 -->
        <div id="resultSection" class="mt-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0" id="resultTitle">作文得分与详细评语</h5>
                </div>
                <div class="card-body">
                    <!-- 添加下载按钮 -->
                    <div class="text-end mb-3">
                        <button id="downloadPdfBtn" class="btn btn-outline-success">
                            <i class="bi bi-file-earmark-pdf"></i> 下载PDF报告
                        </button>
                    </div>
                    
                    <!-- 总分和字数 -->
                    <div class="row mb-4">
                        <div class="col-md-6 text-center">
                            <div class="d-flex justify-content-center align-items-center gap-5">
                                <div class="text-center">
                                    <div class="score-circle" id="totalScore" style="width: 90px; height: 90px; font-size: 2.3rem; font-weight: bold; margin-bottom: 10px;">38</div>
                                    <h5 class="mt-4" style="font-weight: bold; font-size: 1.3rem;">总分</h5>
                                </div>
                                <div class="text-center">
                                    <div id="levelDisplay" style="width: 90px; height: 90px; font-size: 2.3rem; font-weight: bold; line-height: 90px; border-radius: 50%; background-color: #0d6efd; color: white; margin-bottom: 10px;">B</div>
                                    <h5 class="mt-4" style="font-weight: bold; font-size: 1.3rem;">等级</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-bordered">
                                <tr>
                                    <th>字数</th>
                                    <td id="wordCount">800</td>
                                </tr>
                                <tr>
                                    <th>错别字扣分</th>
                                    <td id="spellErrorScore">0</td>
                                </tr>
                                <tr>
                                    <th>内容主旨得分</th>
                                    <td id="contentScore">18</td>
                                </tr>
                                <tr>
                                    <th>表达文采得分</th>
                                    <td id="expressionScore">17</td>
                                </tr>
                                <tr>
                                    <th>结构得分</th>
                                    <td id="structureScore">-</td>
                                </tr>
                                <tr>
                                    <th>书写得分</th>
                                    <td id="writingScore">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 总评 -->
                    <div class="analysis-block">
                        <div class="analysis-header">
                            总评
                        </div>
                        <div class="analysis-content">
                            <h5 class="analysis-subtitle">综合评价</h5>
                            <p id="overall-assessment" class="mb-3"></p>
                            <h5 class="analysis-subtitle">建议改进</h5>
                            <p id="improvement-suggestions" class="mb-0"></p>
                        </div>
                    </div>
                    
                    <!-- 详细分析（非折叠式） -->
                    <div class="detailed-analysis">
                        <!-- 内容主旨分析 -->
                        <div class="analysis-block">
                            <div class="analysis-header">
                                内容主旨分析
                            </div>
                            <div class="analysis-content" id="contentAnalysis">
                            </div>
                        </div>
                        
                        <!-- 表达文采分析 -->
                        <div class="analysis-block">
                            <div class="analysis-header">
                                表达文采分析
                            </div>
                            <div class="analysis-content" id="expressionAnalysis">
                            </div>
                        </div>
                        
                        <!-- 结构分析 -->
                        <div class="analysis-block">
                            <div class="analysis-header">
                                结构分析
                            </div>
                            <div class="analysis-content" id="structureAnalysis">
                            </div>
                        </div>
                        
                        <!-- 错别字分析 -->
                        <div class="analysis-block">
                            <div class="analysis-header">
                                错别字分析
                            </div>
                            <div class="analysis-content">
                                <div id="spellErrorAnalysis"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 添加写作分析（错别字以外的） -->
                    <div class="analysis-block" style="display: none;">
                        <div class="analysis-header">
                            作文书写分析
                        </div>
                        <div class="analysis-content">
                            <div id="writingAnalysis"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card-footer text-muted">
            <div class="row">
                <div class="col text-center">
                    <small>@小园丁作文批改智能体提供服务</small>
                </div>
            </div>
        </div>
        
        <!-- 原始作文内容显示区域 -->
        <div class="analysis-block" id="originalTextSection" style="display: none;">
            <div class="analysis-header">
                作文原文
            </div>
            <div class="analysis-content">
                <h5 class="analysis-subtitle" id="essayTitle"></h5>
                <div id="originalTextContent" style="white-space: pre-wrap;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 添加PDF生成库 html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- 添加jsPDF库和依赖 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // 全局变量
        const urlParams = new URLSearchParams(window.location.search);
        let sessionId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化隐藏结果链接区域
            document.getElementById('resultComplete').style.display = 'none';
            
            // API模式切换
            const apiModeSwitch = document.getElementById('apiModeSwitch');
            if (apiModeSwitch) {
                apiModeSwitch.addEventListener('change', function() {
                    fetch('/toggle_mock', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('currentMode').textContent = data.mock_mode ? '模拟API' : '真实API';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            }
            
            // 链接点击事件 - 在新窗口打开评分结果
            document.getElementById('resultLink').addEventListener('click', function(e) {
                e.preventDefault();
                
                // 复制当前URL并添加查询参数以标识应该显示结果
                let resultUrl = new URL(window.location.href);
                resultUrl.searchParams.set('showResults', 'true');
                
                // 添加作文标题作为参数
                const subject = document.getElementById('subject').value;
                if (subject) {
                    resultUrl.searchParams.set('title', encodeURIComponent(subject));
                }
                
                // 在新窗口中打开结果页面
                window.open(resultUrl.toString(), '_blank');
            });
            
            // 检查URL参数是否需要显示结果
            function checkShowResults() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('showResults') === 'true') {
                    // 如果是在结果页面，显示结果并隐藏其他元素
                    document.getElementById('resultSection').style.display = 'block';
                    document.querySelector('.main-content').style.display = 'none';
                    document.getElementById('resultComplete').style.display = 'none';
                    
                    // 添加结果页面特定的class到body元素
                    document.body.classList.add('results-page');
                    
                    // 从localStorage获取批改结果数据并显示
                    const resultData = JSON.parse(localStorage.getItem('essayCorrectResult'));
                    if (resultData) {
                        displayResults(resultData);
                    }
                    
                    // 滚动到结果区域
                    document.getElementById('resultSection').scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    // 如果是在首页，隐藏原始文本区域
                    document.getElementById('originalTextSection').style.display = 'none';
                }
            }
            
            // 页面加载时检查是否需要显示结果
            checkShowResults();
            
            // 显示批改结果的函数
            function displayResults(data) {
                // 首先处理作文标题
                displayEssayTitle(data);
                
                // 获取作文标题并设置结果标题
                const essayTitle = document.getElementById('essayTitle').textContent || '';
                const resultTitleElem = document.getElementById('resultTitle');
                if (resultTitleElem) {
                    if (essayTitle) {
                        resultTitleElem.textContent = `《${essayTitle}》作文评分报告`;
                    } else {
                        resultTitleElem.textContent = '作文评分报告';
                    }
                }
                
                // 填充结果数据
                const totalScoreElem = document.getElementById('totalScore');
                const gradeElem = document.getElementById('levelDisplay');
                const contentScoreElem = document.getElementById('contentScore');
                const languageScoreElem = document.getElementById('expressionScore');
                const structureScoreElem = document.getElementById('structureScore');
                const writingScoreElem = document.getElementById('writingScore');
                const overallAssessmentElem = document.getElementById('overall-assessment');
                const improvementSuggestionsElem = document.getElementById('improvement-suggestions');
                const contentAnalysisElem = document.getElementById('contentAnalysis');
                const languageAnalysisElem = document.getElementById('expressionAnalysis');
                const structureAnalysisElem = document.getElementById('structureAnalysis');
                
                // 设置各项得分
                totalScoreElem.innerText = data.total_score || '0';
                gradeElem.innerText = data.grade || 'C';
                contentScoreElem.innerText = data.content_score || '0';
                languageScoreElem.innerText = data.language_score || '0';
                structureScoreElem.innerText = data.structure_score || '0';
                writingScoreElem.innerText = data.writing_score || '0';
                
                // 设置分析内容
                const overallText = data.overall_assessment || '未提供整体评价';
                const contentText = data.content_analysis || '未提供内容分析';
                
                // 处理strengths、weaknesses和suggestions
                let strengthsHTML = '';
                let weaknessesHTML = '';
                let suggestionsHTML = '';
                
                // 处理优点 (strengths)
                if (data.strengths && Array.isArray(data.strengths) && data.strengths.length > 0) {
                    strengthsHTML = '<h5 class="analysis-subtitle">优点</h5><ul>';
                    data.strengths.forEach(item => {
                        strengthsHTML += `<li>${item}</li>`;
                    });
                    strengthsHTML += '</ul>';
                }
                
                // 处理不足 (weaknesses)
                if (data.weaknesses && Array.isArray(data.weaknesses) && data.weaknesses.length > 0) {
                    weaknessesHTML = '<h5 class="analysis-subtitle">不足</h5><ul>';
                    data.weaknesses.forEach(item => {
                        weaknessesHTML += `<li>${item}</li>`;
                    });
                    weaknessesHTML += '</ul>';
                }
                
                // 处理建议 (suggestions)
                if (data.suggestions && Array.isArray(data.suggestions) && data.suggestions.length > 0) {
                    suggestionsHTML = '<ul>';
                    data.suggestions.forEach(item => {
                        suggestionsHTML += `<li>${item}</li>`;
                    });
                    suggestionsHTML += '</ul>';
                    improvementSuggestionsElem.innerHTML = suggestionsHTML;
                } else {
                    improvementSuggestionsElem.innerHTML = '<p>无具体改进建议</p>';
                }
                
                // 将优点和不足添加到内容分析中
                if (strengthsHTML || weaknessesHTML) {
                    contentAnalysisElem.innerHTML = strengthsHTML + weaknessesHTML;
                } else {
                    contentAnalysisElem.innerHTML = textToOrderedList(contentText);
                }
                
                // 修改语言分析和结构分析为序列列表
                const languageText = data.language_analysis || '未提供语言分析';
                const structureText = data.structure_analysis || '未提供结构分析';
                
                // 应用序列列表格式
                languageAnalysisElem.innerHTML = createSequentialList(languageText);
                structureAnalysisElem.innerHTML = createSequentialList(structureText);
                
                // 其他显示保持不变
                overallAssessmentElem.innerHTML = textToOrderedList(overallText);
                
                // 处理错别字分析
                processSpellingErrors(data);
                
                // 设置字数
                document.getElementById('wordCount').textContent = data.words_count || '0';
                
                // 设置错别字扣分
                const errorCount = data.error_count || 0;
                // 每3个错别字扣1分，显示为负数
                const errorScore = Math.floor(errorCount / 3);
                if (errorScore > 0) {
                    document.getElementById('spellErrorScore').innerHTML = `<span style="color: red">-${errorScore}</span>`;
                } else {
                    document.getElementById('spellErrorScore').textContent = "0";
                }
                
                // 设置原始作文内容
                const originalTextElem = document.getElementById('originalTextContent');
                if (data.original_text) {
                    originalTextElem.textContent = data.original_text;
                    
                    // 设置作文标题
                    const urlParams = new URLSearchParams(window.location.search);
                    const title = document.getElementById('subject').value || urlParams.get('title') || '';
                    document.getElementById('essayTitle').textContent = title;
                    
                    // 仅在结果页面显示原始文本
                    if (urlParams.get('showResults') === 'true') {
                        document.getElementById('originalTextSection').style.display = 'block';
                        // 将原文区域移动到卡片体内的最后位置
                        const resultSection = document.getElementById('resultSection');
                        const cardBody = resultSection.querySelector('.card-body');
                        const originalTextSection = document.getElementById('originalTextSection');
                        
                        // 确保原文区域只添加一次
                        if (originalTextSection.parentElement !== cardBody) {
                            // 先从当前位置移除
                            if (originalTextSection.parentElement) {
                                originalTextSection.parentElement.removeChild(originalTextSection);
                            }
                            // 添加到卡片体的最后，确保只有一个实例
                            const existingOriginalSection = cardBody.querySelector('#originalTextSection');
                            if (existingOriginalSection) {
                                cardBody.removeChild(existingOriginalSection);
                            }
                            cardBody.appendChild(originalTextSection);
                        }
                    } else {
                        document.getElementById('originalTextSection').style.display = 'none';
                    }
                } else {
                    document.getElementById('originalTextSection').style.display = 'none';
                }
            }
            
            // PDF下载功能
            document.getElementById('downloadPdfBtn').addEventListener('click', function() {
                try {
                    // 显示加载提示（创建在body下而非结果区域内，避免出现在PDF中）
                    const loadingContainer = document.createElement('div');
                    loadingContainer.id = 'pdfLoadingIndicator';
                    loadingContainer.style.position = 'fixed';
                    loadingContainer.style.top = '50%';
                    loadingContainer.style.left = '50%';
                    loadingContainer.style.transform = 'translate(-50%, -50%)';
                    loadingContainer.style.backgroundColor = 'rgba(255,255,255,0.9)';
                    loadingContainer.style.padding = '20px';
                    loadingContainer.style.borderRadius = '5px';
                    loadingContainer.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
                    loadingContainer.style.zIndex = '9999';
                    loadingContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">正在生成PDF，请稍候...</p></div>';
                    document.body.appendChild(loadingContainer);
                    
                    console.log('PDF生成开始...');
                    
                    // 获取作文标题作为PDF文件名
                    let filename = '作文批改报告';
                    const urlTitle = urlParams.get('title');
                    const inputTitle = document.getElementById('subject') ? document.getElementById('subject').value : '';
                    const title = urlTitle ? decodeURIComponent(urlTitle) : inputTitle;
                    if (title) {
                        filename = `${title}-批改报告.pdf`;
                    }
                    
                    // 简单PDF生成尝试
                    try {
                        // 获取结果区域并确保没有重复的原文部分
                        const resultSection = document.querySelector('#resultSection .card');
                        
                        // 临时隐藏PDF下载按钮以避免其在截图中显示
                        const downloadBtn = document.getElementById('downloadPdfBtn');
                        const btnDisplay = downloadBtn.style.display;
                        downloadBtn.style.display = 'none';
                        
                        // 临时移除可能重复的原文部分
                        const cardBody = resultSection.querySelector('.card-body');
                        const originalTextSection = document.getElementById('originalTextSection');
                        const isOriginalSectionVisible = originalTextSection && originalTextSection.style.display !== 'none';
                        
                        // 如果原文区域在卡片体内，临时移除它
                        let isOriginalSectionRemoved = false;
                        if (isOriginalSectionVisible && originalTextSection.parentElement === cardBody) {
                            cardBody.removeChild(originalTextSection);
                            isOriginalSectionRemoved = true;
                        }
                        
                        // 创建临时容器，包含评分结果和原文
                        const tempContainer = document.createElement('div');
                        
                        // 添加标题
                        const titleDiv = document.createElement('div');
                        titleDiv.style.textAlign = 'center';
                        titleDiv.style.margin = '20px 0';
                        titleDiv.style.pageBreakAfter = 'avoid';
                        
                        // 获取作文标题
                        const essayTitle = document.getElementById('essayTitle').textContent || '';
                        const reportTitle = document.createElement('h2');
                        reportTitle.style.fontSize = '22px';
                        reportTitle.style.fontWeight = 'bold';
                        reportTitle.style.marginBottom = '10px';
                        
                        if (essayTitle) {
                            reportTitle.textContent = `《${essayTitle}》作文评分报告`;
                        } else {
                            reportTitle.textContent = '作文评分报告';
                        }
                        
                        titleDiv.appendChild(reportTitle);
                        tempContainer.appendChild(titleDiv);
                        
                        // 添加批改结果
                        tempContainer.appendChild(resultSection.cloneNode(true));
                        
                        // 再次单独添加原文内容(如果有)
                        if (isOriginalSectionVisible) {
                            // 添加分页符
                            const pageBreak = document.createElement('div');
                            pageBreak.style.pageBreakBefore = 'always';
                            tempContainer.appendChild(pageBreak);
                            
                            // 添加原文标题
                            const originalTitleDiv = document.createElement('div');
                            originalTitleDiv.style.textAlign = 'center';
                            originalTitleDiv.style.margin = '20px 0';
                            
                            const originalTitle = document.createElement('h3');
                            originalTitle.style.fontSize = '18px';
                            originalTitle.style.fontWeight = 'bold';
                            originalTitle.textContent = '作文原文';
                            
                            originalTitleDiv.appendChild(originalTitle);
                            tempContainer.appendChild(originalTitleDiv);
                            
                            // 添加文章标题
                            if (essayTitle) {
                                const essayTitleDiv = document.createElement('h4');
                                essayTitleDiv.style.textAlign = 'center';
                                essayTitleDiv.style.margin = '10px 0 20px';
                                essayTitleDiv.style.fontWeight = 'normal';
                                essayTitleDiv.textContent = essayTitle;
                                tempContainer.appendChild(essayTitleDiv);
                            }
                            
                            // 添加原文内容
                            const contentDiv = document.createElement('div');
                            contentDiv.style.margin = '10px 20px';
                            contentDiv.style.fontFamily = 'SimSun, serif';
                            contentDiv.style.lineHeight = '1.8';
                            contentDiv.style.whiteSpace = 'pre-wrap';
                            contentDiv.textContent = originalTextSection.querySelector('#originalTextContent').textContent;
                            tempContainer.appendChild(contentDiv);
                        }
                        
                        // 如果原文区域之前被移除，恢复它
                        if (isOriginalSectionRemoved) {
                            cardBody.appendChild(originalTextSection);
                        }
                        
                        // 恢复下载按钮显示
                        downloadBtn.style.display = btnDisplay;
                        
                        // 尝试使用html2pdf.js简化版
                        const html2pdfOptions = {
                            margin: 15, // 增加页边距
                            filename: filename,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { 
                                scale: 2.0, 
                                useCORS: true,
                                scrollX: 0,
                                scrollY: 0,
                                backgroundColor: '#ffffff'
                            },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        };
                        
                        // 直接使用临时容器
                        html2pdf().from(tempContainer).set(html2pdfOptions).save()
                            .then(() => {
                                console.log('PDF生成完成(简化版)');
                                // 移除加载提示
                                const loadingIndicator = document.getElementById('pdfLoadingIndicator');
                                if (loadingIndicator && loadingIndicator.parentNode) {
                                    loadingIndicator.parentNode.removeChild(loadingIndicator);
                                }
                            })
                            .catch(simplePdfError => {
                                console.error('简化PDF方法初始化失败，使用标准方法:', simplePdfError);
                                // 失败时尝试标准方法
                                generateDetailedPDF();
                            });
                        
                        return; // 提前返回，等待html2pdf处理完成
                    } catch (simpleTryError) {
                        console.warn('简化PDF方法初始化失败，使用标准方法:', simpleTryError);
                        // 继续使用标准方法
                    }
                    
                    // 标准PDF生成函数
                    function generateDetailedPDF() {
                        try {
                            // 创建jspdf对象
                            if (!window.jspdf) {
                                throw new Error('jsPDF库未正确加载');
                            }
                            
                            const pdf = new window.jspdf.jsPDF({
                                orientation: 'portrait',
                                unit: 'mm',
                                format: 'a4',
                                compress: true
                            });
                            
                            // 设置A4页面尺寸
                            const pageWidth = pdf.internal.pageSize.getWidth();
                            const pageHeight = pdf.internal.pageSize.getHeight();
                            const margin = 15; // 增加页边距
                            
                            // 临时处理：移除可能导致重复的元素
                            const resultElement = document.querySelector('#resultSection .card');
                            const cardBody = resultElement.querySelector('.card-body');
                            const originalTextSection = document.getElementById('originalTextSection');
                            
                            // 临时移除原文区域以避免重复
                            let isOriginalSectionRemoved = false;
                            if (originalTextSection && originalTextSection.parentElement === cardBody) {
                                cardBody.removeChild(originalTextSection);
                                isOriginalSectionRemoved = true;
                            }
                            
                            // 临时隐藏PDF下载按钮以避免其在截图中显示
                            const downloadBtn = document.getElementById('downloadPdfBtn');
                            const btnDisplay = downloadBtn.style.display;
                            downloadBtn.style.display = 'none';
                            
                            // 定义需要截图的各个区域，不包括原文
                            const scoreElement = document.querySelector('#resultSection .row.mb-4');
                            const overallElement = document.querySelector('#resultSection .analysis-block:nth-of-type(1)');
                            const contentAnalysisElement = document.querySelector('#resultSection .analysis-block:nth-of-type(2)');
                            const expressionAnalysisElement = document.querySelector('#resultSection .analysis-block:nth-of-type(3)');
                            const structureAnalysisElement = document.querySelector('#resultSection .analysis-block:nth-of-type(4)');
                            const spellingAnalysisElement = document.querySelector('#resultSection .analysis-block:nth-of-type(5)');
                            const writingAnalysisElement = document.querySelector('#resultSection .analysis-block:nth-of-type(6)');
                            
                            // 要处理的元素列表，根据显示状态过滤，不包括原文
                            const elementsToProcess = [
                                { element: scoreElement, label: '得分区域' },
                                { element: overallElement, label: '总评' },
                                { element: contentAnalysisElement, label: '内容分析' },
                                { element: expressionAnalysisElement, label: '表达文采分析' },
                                { element: structureAnalysisElement, label: '结构分析', visible: structureAnalysisElement && structureAnalysisElement.style.display !== 'none' },
                                { element: spellingAnalysisElement, label: '错别字分析' },
                                { element: writingAnalysisElement, label: '作文书写分析', visible: writingAnalysisElement && writingAnalysisElement.style.display !== 'none' }
                            ].filter(item => item.element && (item.visible === undefined || item.visible));
                            
                            // 对有效元素执行html2canvas，使用较低的缩放以避免内存问题
                            const canvasPromises = elementsToProcess.map(item => 
                                html2canvas(item.element, { 
                                    scale: 2.0, 
                                    useCORS: true, 
                                    logging: false, 
                                    allowTaint: true,
                                    backgroundColor: '#ffffff'
                                })
                            );
                            
                            // 获取所有需要渲染到PDF的内容
                            Promise.all(canvasPromises).then(async function(canvases) {
                                try {
                                    // 恢复下载按钮显示
                                    downloadBtn.style.display = btnDisplay;
                                    
                                    // 恢复原文区域
                                    if (isOriginalSectionRemoved) {
                                        cardBody.appendChild(originalTextSection);
                                    }
                                    
                                    // 先添加作文标题作为PDF报告标题
                                    const essayTitle = document.getElementById('essayTitle').textContent || '';
                                    
                                    // 设置初始Y坐标
                                    let yPosition = margin;
                                    
                                    // 添加报告标题
                                    pdf.setFontSize(16);
                                    pdf.setTextColor(0, 0, 0);
                                    const mainTitleText = essayTitle ? `《${essayTitle}》作文评分报告` : '作文评分报告';
                                    pdf.text(mainTitleText, pageWidth / 2, yPosition + 10, { align: 'center' });
                                    yPosition += 25; // 标题后增加空间
                                    
                                    // 循环处理每个元素的Canvas
                                    for (let i = 0; i < canvases.length; i++) {
                                        // 获取当前处理的元素信息
                                        const currentElementInfo = elementsToProcess[i];
                                        
                                        // 生成图像数据
                                        let imgData = canvases[i].toDataURL('image/jpeg', 1.0);
                                        let imgWidth = pageWidth - (2 * margin);
                                        let imgHeight = (canvases[i].height * imgWidth) / canvases[i].width;
                                        
                                        // 检查是否需要分页
                                        if (yPosition + imgHeight > pageHeight - margin) {
                                            pdf.addPage();
                                            yPosition = margin;
                                        }
                                        
                                        // 添加图像到PDF
                                        pdf.addImage(imgData, 'JPEG', margin, yPosition, imgWidth, imgHeight);
                                        yPosition += imgHeight + 5;
                                        
                                        console.log(`已添加 ${currentElementInfo.label} 到PDF`);
                                    }
                                    
                                    // 添加作文标题和原始作文内容（如果有）
                                    const originalTextSection = document.getElementById('originalTextSection');
                                    if (originalTextSection && originalTextSection.style.display !== 'none') {
                                        // 获取作文标题
                                        const essayTitle = document.getElementById('essayTitle').textContent || '';
                                        
                                        // 添加新页面
                                        pdf.addPage();
                                        yPosition = margin;
                                        
                                        // 添加原始作文内容标题
                                        pdf.setFontSize(14);
                                        pdf.setTextColor(0, 0, 0);
                                        
                                        // 添加原文标题
                                        pdf.text('作文原文', pageWidth / 2, yPosition, { align: 'center' });
                                        yPosition += 8;
                                        
                                        // 添加作文标题
                                        if (essayTitle) {
                                            pdf.setFontSize(12);
                                            pdf.text(essayTitle, pageWidth / 2, yPosition, { align: 'center' });
                                            yPosition += 12;
                                        }
                                        
                                        // 添加作文内容
                                        pdf.setFontSize(11);
                                        pdf.setTextColor(50, 50, 50);
                                        
                                        const originalText = document.getElementById('originalTextContent').textContent;
                                        if (originalText && originalText.trim()) {
                                            const textLines = pdf.splitTextToSize(originalText, pageWidth - (2 * margin));
                                            
                                            // 检查是否需要新页面
                                            if (yPosition + (textLines.length * 5) > pageHeight - margin) {
                                                const linesPerPage = Math.floor((pageHeight - yPosition - margin) / 5);
                                                const firstPageLines = textLines.slice(0, linesPerPage);
                                                pdf.text(firstPageLines, margin, yPosition);
                                                
                                                // 剩余内容放到新页面
                                                let remainingLines = textLines.slice(linesPerPage);
                                                let currentPage = 1;
                                                
                                                while (remainingLines.length > 0) {
                                                    pdf.addPage();
                                                    const pageLines = remainingLines.slice(0, Math.floor((pageHeight - (2 * margin)) / 5));
                                                    pdf.text(pageLines, margin, margin + 5);
                                                    remainingLines = remainingLines.slice(pageLines.length);
                                                    currentPage++;
                                                }
                                            } else {
                                                pdf.text(textLines, margin, yPosition);
                                            }
                                        } else {
                                            pdf.text("暂无原文内容", margin, yPosition);
                                        }
                                    } else {
                                        console.log("不添加原始文本：未找到或不可见");
                                    }
                                    
                                    // 添加页码
                                    const totalPages = pdf.getNumberOfPages();
                                    for (let i = 1; i <= totalPages; i++) {
                                        pdf.setPage(i);
                                        pdf.setFontSize(10);
                                        pdf.setTextColor(100, 100, 100);
                                        pdf.text(`${i} / ${totalPages}`, pageWidth / 2, pageHeight - 5, {
                                            align: 'center'
                                        });
                                    }
                                    
                                    console.log('保存PDF...');
                                    try {
                                        // 保存PDF
                                        pdf.save(filename);
                                        console.log('PDF生成完成');
                                    } catch (saveError) {
                                        console.error('PDF保存错误:', saveError);
                                        alert(`PDF保存失败: ${saveError.message || '未知错误'}\n请检查文件名或尝试使用无特殊字符的标题`);
                                    }
                                } catch (canvasError) {
                                    console.error('Canvas处理错误:', canvasError);
                                    alert(`PDF生成失败: ${canvasError.message || '内容处理错误'}\n请尝试刷新页面后重试`);
                                }
                                
                                // 移除加载提示
                                const loadingIndicator = document.getElementById('pdfLoadingIndicator');
                                if (loadingIndicator && loadingIndicator.parentNode) {
                                    loadingIndicator.parentNode.removeChild(loadingIndicator);
                                }
                                
                            }).catch(function(error) {
                                console.error('HTML2Canvas错误:', error);
                                alert(`PDF生成失败: ${error.message || '无法渲染内容'}\n可能是内容过多或浏览器内存不足，请尝试刷新页面后重试`);
                                
                                // 恢复下载按钮
                                downloadBtn.style.display = btnDisplay;
                                
                                // 移除加载提示
                                const loadingIndicator = document.getElementById('pdfLoadingIndicator');
                                if (loadingIndicator && loadingIndicator.parentNode) {
                                    loadingIndicator.parentNode.removeChild(loadingIndicator);
                                }
                            });
                        } catch (detailedError) {
                            console.error('标准PDF生成失败:', detailedError);
                            alert(`PDF生成初始化失败: ${detailedError.message || '未知错误'}`);
                            
                            // 移除加载提示
                            const loadingIndicator = document.getElementById('pdfLoadingIndicator');
                            if (loadingIndicator && loadingIndicator.parentNode) {
                                loadingIndicator.parentNode.removeChild(loadingIndicator);
                            }
                        }
                    }
                    
                    // 执行标准PDF生成
                    generateDetailedPDF();
                    
                } catch (error) {
                    console.error('PDF生成主函数错误:', error);
                    alert(`PDF生成失败: ${error.message || '初始化失败'}\n请确保您的浏览器支持PDF生成功能`);
                    
                    // 移除可能存在的加载提示
                    const loadingIndicator = document.getElementById('pdfLoadingIndicator');
                    if (loadingIndicator && loadingIndicator.parentNode) {
                        loadingIndicator.parentNode.removeChild(loadingIndicator);
                    }
                }
            });
            
            // 表单提交
            document.getElementById('essayForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 获取表单数据
                const subject = document.getElementById('subject').value;
                const article = document.getElementById('article').value;
                const fileUpload = document.getElementById('fileUpload').files[0];
                
                // 检查是否至少有一种输入方式：手动输入或文件上传
                if (!article && !fileUpload) {
                    alert('请填写作文内容，或上传文件！');
                    return;
                }
                
                // 显示加载动画
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('resultSection').style.display = 'none';
                document.getElementById('resultComplete').style.display = 'none';
                
                // 检查是否启用debug模式（按住Ctrl点击提交按钮）
                const isDebugMode = e.ctrlKey || localStorage.getItem('debugMode') === 'true';
                if (isDebugMode) {
                    document.getElementById('processingStatus').classList.remove('d-none');
                    document.getElementById('statusText').textContent = '正在准备处理，已开启调试模式...';
                }
                
                // 提交作文
                const formData = new FormData();
                formData.append('subject', subject);
                
                if (article) {
                    formData.append('article', article);
                }
                
                if (fileUpload) {
                    formData.append('file', fileUpload);
                    if (isDebugMode) {
                        document.getElementById('statusText').textContent = `正在上传文件：${fileUpload.name} (${(fileUpload.size/1024).toFixed(2)}KB)`;
                    }
                }
                
                // 添加debug标记
                if (isDebugMode) {
                    formData.append('debug', 'true');
                }
                
                fetch('/correct', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || '批改过程中发生错误');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // 隐藏加载动画，显示结果链接
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('resultComplete').style.display = 'block';
                    
                    // 检查是否有错误
                    if (!data.success) {
                        throw new Error(data.error || '批改过程中发生错误');
                    }
                    
                    // 保存结果数据到localStorage以供新窗口使用
                    localStorage.setItem('essayCorrectResult', JSON.stringify(data));
                    
                    // 填充结果数据到当前页面
                    displayResults(data);
                    
                    // 滚动到结果链接区域
                    document.getElementById('resultComplete').scrollIntoView({
                        behavior: 'smooth'
                    });
                })
                .catch(error => {
                    console.error('错误:', error);
                    document.getElementById('loadingSpinner').style.display = 'none';
                    alert(error.message || '批改失败，请重试');
                });
            });
            
            // 文件上传事件处理
            document.getElementById('fileUpload').addEventListener('change', function(e) {
                const fileDisplay = document.getElementById('fileDisplay');
                const fileNameDisplay = fileDisplay.querySelector('.file-name');
                
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    fileNameDisplay.textContent = `已选择文件: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                    fileDisplay.classList.remove('d-none');
                } else {
                    fileDisplay.classList.add('d-none');
                }
            });
            
            // 移除文件按钮
            document.querySelector('#fileDisplay .btn-close').addEventListener('click', function() {
                document.getElementById('fileUpload').value = '';
                document.getElementById('fileDisplay').classList.add('d-none');
            });

            // 处理作文标题显示
            function displayEssayTitle(data) {
                const titleElem = document.getElementById('essayTitle');
                
                // 尝试从URL参数获取标题
                const urlTitle = urlParams.get('title');
                // 尝试从输入框获取标题
                const inputTitle = document.getElementById('subject') ? document.getElementById('subject').value : '';
                // 从原始文本提取标题
                let extractedTitle = '';
                if (data.original_text) {
                    const lines = data.original_text.split('\n');
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed && !trimmed.match(/^第.+[章节篇]/) && trimmed.length < 20) {
                            extractedTitle = trimmed;
                            break;
                        }
                    }
                }
                
                // 优先使用URL参数标题，其次使用输入标题，最后使用提取标题
                const finalTitle = urlTitle || inputTitle || extractedTitle || '未命名作文';
                
                // 设置标题，前面加空格间隔
                if (titleElem) {
                    titleElem.textContent = finalTitle;
                }
            }

            // 处理writing_analysis中的错别字信息
            function processSpellingErrors(data) {
                const spellErrorElem = document.getElementById('spellErrorAnalysis');
                
                // 检查是否包含错别字分析
                if (data.writing_analysis && data.writing_analysis.includes('错别字')) {
                    console.log("检测到错别字分析:", data.writing_analysis);
                    let errorHTML = '';
                    
                    try {
                        // 尝试直接匹配格式："发现X个错别字：【错误】应为【正确】，位置：位置信息"
                        const fullRegex = /发现(\d+)个错别字[：:]\s*(.*)/;
                        const fullMatch = data.writing_analysis.match(fullRegex);
                        
                        if (fullMatch) {
                            const errorCount = fullMatch[1];
                            const errorDetails = fullMatch[2];
                            console.log(`找到${errorCount}个错别字，详情:`, errorDetails);
                            
                            // 分割每个错别字信息
                            const errorItems = errorDetails.split(/[；;]/);
                            
                            errorItems.forEach((item, idx) => {
                                if (!item.trim()) return; // 跳过空项
                                
                                console.log(`处理第${idx+1}个错别字项:`, item);
                                // 解析每个错别字项 - 使用宽松的正则表达式
                                const itemMatch = item.match(/【([^】]+)】应为\s*[【\s]*([^】\s,，]+)[】\s]*[，,]?\s*位置[:：]\s*([^；;]*)/);
                                
                                if (itemMatch) {
                                    const wrongWord = itemMatch[1];
                                    const correctWord = itemMatch[2];
                                    const position = itemMatch[3];
                                    
                                    console.log(`解析结果: 错误="${wrongWord}", 正确="${correctWord}", 位置="${position}"`);
                                    errorHTML += createErrorItemHTML(idx+1, wrongWord, correctWord, position);
                                } else {
                                    console.log(`无法匹配错别字项: ${item}`);
                                }
                            });
                        } else {
                            // 尝试分别匹配每个错别字项
                            console.log("未找到完整格式，尝试逐项匹配");
                            const singleRegex = /【([^】]+)】应为\s*[【\s]*([^】\s,，]+)[】\s]*[，,]?\s*位置[:：]\s*([^；;]*)/g;
                            let match;
                            let index = 0;
                            
                            while ((match = singleRegex.exec(data.writing_analysis)) !== null) {
                                index++;
                                const wrongWord = match[1];
                                const correctWord = match[2];
                                const position = match[3];
                                
                                console.log(`直接匹配项${index}: 错误="${wrongWord}", 正确="${correctWord}", 位置="${position}"`);
                                errorHTML += createErrorItemHTML(index, wrongWord, correctWord, position);
                            }
                            
                            // 如果还没匹配到，使用更宽松的正则
                            if (index === 0) {
                                console.log("尝试使用更宽松的匹配模式");
                                const looseRegex = /【([^】]+)】应为\s*[【\s]*([^】\s,，]+)[】\s]*/g;
                                let looseIndex = 0;
                                
                                while ((match = looseRegex.exec(data.writing_analysis)) !== null) {
                                    looseIndex++;
                                    const wrongWord = match[1];
                                    const correctWord = match[2];
                                    let position = "未指定";
                                    
                                    // 尝试在匹配后的文本中寻找位置信息
                                    const afterText = data.writing_analysis.substring(match.index + match[0].length);
                                    const posMatch = afterText.match(/位置[:：]\s*([^；;]*)/);
                                    if (posMatch) {
                                        position = posMatch[1];
                                    }
                                    
                                    console.log(`宽松匹配项${looseIndex}: 错误="${wrongWord}", 正确="${correctWord}", 位置="${position}"`);
                                    errorHTML += createErrorItemHTML(looseIndex, wrongWord, correctWord, position);
                                }
                            }
                        }
                        
                        // 如果仍然没有匹配到任何错别字，但我们知道有错别字
                        if (!errorHTML && data.writing_analysis.includes('错别字')) {
                            console.log("使用硬编码方式解析特定格式");
                            // 针对第一篇文章的硬编码处理
                            if (data.writing_analysis.includes('【酒】应为【洒】')) {
                                errorHTML += createErrorItemHTML(1, '酒', '洒', '第一段第1行');
                            }
                            if (data.writing_analysis.includes('【一股骨碌】应为【一骨碌】')) {
                                errorHTML += createErrorItemHTML(2, '一股骨碌', '一骨碌', '第一段第3行');
                            }
                            if (data.writing_analysis.includes('【勿忙】应为【匆忙】')) {
                                errorHTML += createErrorItemHTML(3, '勿忙', '匆忙', '倒数第二段第1句');
                            }
                            
                            // 针对第二篇文章的硬编码处理
                            if (data.writing_analysis.includes('【滋滋有味】应为')) {
                                errorHTML += createErrorItemHTML(1, '滋滋有味', '津津有味', '第五段第1句');
                            }
                        }
                    } catch (e) {
                        console.error("解析错别字出错:", e);
                    }
                    
                    if (errorHTML) {
                        spellErrorElem.innerHTML = `
                            <div class="mb-4">
                                <div class="error-items-container">
                                    ${errorHTML}
                                </div>
                            </div>
                        `;
                        spellErrorElem.style.display = 'block';
                        console.log("显示错别字分析结果");
                    } else {
                        // 如果没有找到错别字但分析中提到"无错别字"或类似内容
                        if (data.writing_analysis.includes('无明显错别字') || 
                            data.writing_analysis.includes('没有错别字') || 
                            data.writing_analysis.includes('格式规范')) {
                            spellErrorElem.innerHTML = `
                                <div class="mb-4">
                                    <p class="mb-0">未发现错别字，很棒！</p>
                                </div>
                            `;
                            spellErrorElem.style.display = 'block';
                        } else {
                            spellErrorElem.style.display = 'none';
                            console.log("未找到错别字信息，隐藏错别字分析区域");
                        }
                    }
                } else {
                    spellErrorElem.style.display = 'none';
                }
            }

            // 创建错别字项的HTML
            function createErrorItemHTML(index, wrongWord, correctWord, position) {
                return `
                    <div class="error-card">
                        <div class="error-header">
                            <span class="error-number">${index}</span>
                            <span class="error-text">
                                <span class="error-wrong">【${wrongWord}】</span>应为<span class="error-correct">【${correctWord}】</span>
                            </span>
                        </div>
                        <div class="error-content">
                            <small>位置：${position}</small>
                        </div>
                    </div>
                `;
            }

            // 在language_analysis和structure_analysis部分添加序列列表显示功能
            function createSequentialList(text) {
                if (!text) return '';
                
                // 分割文本为句子
                const sentences = text.split(/[。；;]/);
                let listItems = '';
                let counter = 1;
                
                sentences.forEach(sentence => {
                    const trimmed = sentence.trim();
                    if (trimmed) {
                        // 去除已有的序号前缀（如 "1. ", "2. " 等）
                        const cleanSentence = trimmed.replace(/^\d+\.\s*/, '');
                        listItems += `<li class="mb-2">${cleanSentence}</li>`;
                        counter++;
                    }
                });
                
                return `<ol class="analysis-list">${listItems}</ol>`;
            }

            // 将长文本转换为有序列表格式
            function textToOrderedList(text) {
                // 检查文本长度，如果文本较长（例如超过100个字符），则考虑将其转换为列表
                if (text && text.length > 100) {
                    // 尝试按句号、分号或感叹号分割文本成多个句子
                    const sentences = text.split(/[。；！.;!]\s*/).filter(s => s.trim().length > 0);
                    
                    // 如果分割后有多个句子，使用有序列表展示
                    if (sentences.length > 1) {
                        let listHtml = '<ol>';
                        sentences.forEach(sentence => {
                            if (sentence.trim().length > 0) {
                                listHtml += `<li>${sentence.trim()}</li>`;
                            }
                        });
                        listHtml += '</ol>';
                        return listHtml;
                    }
                }
                
                // 如果不需要转换为列表，直接返回原文本
                return `<p>${text}</p>`;
            }
        });
    </script>
</body>
</html>